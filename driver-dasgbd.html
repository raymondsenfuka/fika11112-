<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Driver Dashboard - Fika Connect</title>
    <meta name="description" content="Fika Connect driver dashboard for managing assigned deliveries and available bookings.">
    <meta name="author" content="Fika Connect">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIINfQ7oY0QLfLpS2LCf7saKFD7HL7o6SRM=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .container {
            max-width: 1200px;
        }
        #map {
            height: 400px;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">
    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-lg p-6 mb-8 flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-truck text-4xl text-emerald-600 mr-4"></i>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Driver Dashboard</h1>
                    <p id="welcome-message" class="text-gray-600 mt-1"></p>
                </div>
            </div>
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                <span id="driver-availability" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-full">Status: Offline</span>
                <button id="availability-toggle-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-full transition-colors">Go Online</button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-colors">Logout</button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Available Bookings & Assigned Deliveries -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Available Bookings Section -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Available Bookings</h2>
                        <div class="flex items-center space-x-2">
                            <label for="service-radius-select" class="text-gray-600 text-sm">Radius:</label>
                            <select id="service-radius-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="5000">5 km</option>
                                <option value="10000">10 km</option>
                                <option value="20000">20 km</option>
                            </select>
                        </div>
                    </div>
                    <div id="available-bookings-list" class="space-y-4">
                        <!-- Bookings will be loaded here -->
                        <p id="available-bookings-loading" class="text-center text-gray-500">Loading available bookings...</p>
                        <p id="available-bookings-error" class="hidden text-center text-red-500">Failed to load bookings. Please try again.</p>
                    </div>
                </section>

                <!-- Assigned Deliveries Section -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Assigned Deliveries</h2>
                    <div id="assigned-deliveries-list" class="space-y-4">
                        <!-- Deliveries will be loaded here -->
                        <p id="assigned-deliveries-loading" class="text-center text-gray-500">Loading assigned deliveries...</p>
                        <p id="assigned-deliveries-error" class="hidden text-center text-red-500">Failed to load deliveries. Please try again.</p>
                    </div>
                </section>
            </div>

            <!-- Right Column: Driver Profile, Performance & Map -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Driver Profile/Performance Section -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Performance</h2>
                    <div class="space-y-4 text-center">
                        <div>
                            <span id="total-deliveries" class="text-4xl font-bold text-emerald-600">0</span>
                            <p class="text-gray-600">Total Deliveries</p>
                        </div>
                        <div>
                            <span id="rating" class="text-4xl font-bold text-yellow-500">N/A</span>
                            <p class="text-gray-600">Average Rating</p>
                        </div>
                    </div>
                </section>

                <!-- Map Section -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Live Map</h2>
                    <div id="map" class="rounded-lg"></div>
                    <div class="flex space-x-2 mt-4">
                        <button id="start-tracking-btn" class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-md transition-colors">Start Tracking</button>
                        <button id="stop-tracking-btn" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-md transition-colors" disabled>Stop Tracking</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal HTML -->
    <div id="custom-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full sm:p-6">
                <div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                        <div class="mt-2">
                            <p id="modal-message" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button type="button" id="modal-close-btn" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:text-sm">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables for Firebase and other data
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let CURRENT_DRIVER_ID = null;
        let map = null;
        let routingControl = null;
        let locationTrackingInterval = null;
        let driverAvailabilityUnsubscribe = null;
        let assignedDeliveriesUnsubscribe = null;
        let availableBookingsUnsubscribe = null;

        // --- Custom Modal Function ---
        function showModal(title, message) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const closeBtn = document.getElementById('modal-close-btn');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');

            closeBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // --- Initialization and UI Functions ---
        async function initDriverMap() {
            if (!map) {
                map = L.map('map').setView([0, 0], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }
        }

        async function fetchAndDisplayBookings() {
            if (!CURRENT_DRIVER_ID) {
                console.error("Driver ID not available.");
                return;
            }

            const assignedDeliveriesList = document.getElementById('assigned-deliveries-list');
            const assignedDeliveriesLoading = document.getElementById('assigned-deliveries-loading');
            const assignedDeliveriesError = document.getElementById('assigned-deliveries-error');

            assignedDeliveriesLoading.style.display = 'block';
            assignedDeliveriesError.style.display = 'none';
            assignedDeliveriesList.innerHTML = '';

            const assignedBookingsRef = collection(db, `artifacts/${appId}/public/data/bookings`);
            const assignedQuery = query(assignedBookingsRef, where("driverId", "==", CURRENT_DRIVER_ID), where("status", "in", ["Confirmed", "Picked Up"]));

            if (assignedDeliveriesUnsubscribe) assignedDeliveriesUnsubscribe();
            assignedDeliveriesUnsubscribe = onSnapshot(assignedQuery, (querySnapshot) => {
                assignedDeliveriesList.innerHTML = '';
                if (querySnapshot.empty) {
                    assignedDeliveriesList.innerHTML = `<p class="text-center text-gray-500">No assigned deliveries yet.</p>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const booking = doc.data();
                        assignedDeliveriesList.innerHTML += createBookingCard(doc.id, booking, true);
                    });
                }
                assignedDeliveriesLoading.style.display = 'none';
            }, (error) => {
                console.error("Error fetching assigned deliveries:", error);
                assignedDeliveriesError.style.display = 'block';
                assignedDeliveriesLoading.style.display = 'none';
            });

            filterAndDisplayAvailableBookings();
        }

        async function filterAndDisplayAvailableBookings() {
            if (!CURRENT_DRIVER_ID) {
                console.error("Driver ID not available.");
                return;
            }

            const availableBookingsList = document.getElementById('available-bookings-list');
            const availableBookingsLoading = document.getElementById('available-bookings-loading');
            const availableBookingsError = document.getElementById('available-bookings-error');
            const serviceRadius = document.getElementById('service-radius-select').value;

            availableBookingsLoading.style.display = 'block';
            availableBookingsError.style.display = 'none';
            availableBookingsList.innerHTML = '';

            // Check for driver location before proceeding
            const driverDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/drivers`, CURRENT_DRIVER_ID));
            if (!driverDoc.exists() || !driverDoc.data().location) {
                availableBookingsList.innerHTML = `<p class="text-center text-gray-500">Driver location not available. Start tracking to see bookings.</p>`;
                availableBookingsLoading.style.display = 'none';
                return;
            }
            const driverLocation = driverDoc.data().location;

            const bookingsRef = collection(db, `artifacts/${appId}/public/data/bookings`);
            const availableQuery = query(bookingsRef, where("status", "==", "Pending"));

            if (availableBookingsUnsubscribe) availableBookingsUnsubscribe();
            availableBookingsUnsubscribe = onSnapshot(availableQuery, (querySnapshot) => {
                availableBookingsList.innerHTML = '';
                const filteredBookings = [];
                querySnapshot.forEach((doc) => {
                    const booking = doc.data();
                    const distance = calculateDistance(driverLocation.latitude, driverLocation.longitude, booking.pickupLocation.latitude, booking.pickupLocation.longitude);
                    if (distance <= serviceRadius) {
                        // Correctly store the doc ID along with the data
                        filteredBookings.push({ id: doc.id, ...booking });
                    }
                });

                if (filteredBookings.length === 0) {
                    availableBookingsList.innerHTML = `<p class="text-center text-gray-500">No available bookings in your selected radius.</p>`;
                } else {
                    // Correctly pass the ID to the card creation function
                    filteredBookings.forEach(booking => {
                         availableBookingsList.innerHTML += createBookingCard(booking.id, booking);
                    });
                }
                availableBookingsLoading.style.display = 'none';
            }, (error) => {
                console.error("Error fetching available bookings:", error);
                availableBookingsError.style.display = 'block';
                availableBookingsLoading.style.display = 'none';
            });
        }

        async function fetchDriverPerformance() {
            if (!CURRENT_DRIVER_ID) return;
            const driverRef = doc(db, `artifacts/${appId}/public/data/drivers`, CURRENT_DRIVER_ID);
            onSnapshot(driverRef, (docSnap) => {
                if (docSnap.exists()) {
                    const driverData = docSnap.data();
                    document.getElementById('total-deliveries').textContent = driverData.completedBookingsCount || 0;
                    // Fix: Check if averageRating is a number before using toFixed
                    const rating = driverData.averageRating;
                    document.getElementById('rating').textContent = typeof rating === 'number' ? rating.toFixed(1) : 'N/A';
                }
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180; // φ, λ in radians
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // in meters
        }

        // --- Event Handlers and API Calls ---
        async function toggleAvailability() {
            if (!CURRENT_DRIVER_ID) return;
            const driverRef = doc(db, `artifacts/${appId}/public/data/drivers`, CURRENT_DRIVER_ID);
            const toggleBtn = document.getElementById('availability-toggle-btn');
            const statusSpan = document.getElementById('driver-availability');

            if (toggleBtn.textContent === 'Go Online') {
                toggleBtn.textContent = 'Go Offline';
                toggleBtn.classList.remove('bg-emerald-600');
                toggleBtn.classList.add('bg-red-500');
                statusSpan.textContent = 'Status: Online';
                await updateDoc(driverRef, { isAvailable: true });
            } else {
                toggleBtn.textContent = 'Go Online';
                toggleBtn.classList.remove('bg-red-500');
                toggleBtn.classList.add('bg-emerald-600');
                statusSpan.textContent = 'Status: Offline';
                await updateDoc(driverRef, { isAvailable: false });
            }
        }

        function createBookingCard(bookingId, booking, isAssigned = false) {
            const cardHtml = `
            <div class="bg-gray-50 rounded-lg p-4 shadow">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-800">Booking #${bookingId}</h4>
                    <span class="text-sm px-2 py-1 rounded-full text-white ${isAssigned ? 'bg-blue-500' : 'bg-emerald-500'}">${isAssigned ? 'Assigned' : 'Pending'}</span>
                </div>
                <div class="text-sm text-gray-600 space-y-1">
                    <p><strong>From:</strong> ${booking.pickupLocation.address}</p>
                    <p><strong>To:</strong> ${booking.deliveryLocation.address}</p>
                    <p><strong>Fare:</strong> $${booking.paymentDetails.estimatedFare}</p>
                </div>
                <div class="mt-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                    ${isAssigned ? `
                        <button onclick="startRoute('${booking.pickupLocation.latitude}', '${booking.pickupLocation.longitude}', '${booking.deliveryLocation.latitude}', '${booking.deliveryLocation.longitude}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            <i class="fas fa-route mr-2"></i> Start Route
                        </button>
                        <button onclick="updateStatus('${bookingId}', 'Picked Up')" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            <i class="fas fa-box-open mr-2"></i> Picked Up
                        </button>
                        <button onclick="updateStatus('${bookingId}', 'Completed')" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            <i class="fas fa-check-circle mr-2"></i> Complete
                        </button>
                    ` : `
                        <button onclick="acceptBooking('${bookingId}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            <i class="fas fa-check mr-2"></i> Accept Booking
                        </button>
                    `}
                </div>
            </div>`;
            return cardHtml;
        }

        // Fix: startRoute now accepts real coordinates
        function startRoute(pickupLat, pickupLon, deliveryLat, deliveryLon) {
            if (map) {
                if (routingControl) {
                    map.removeControl(routingControl);
                }
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(parseFloat(pickupLat), parseFloat(pickupLon)),
                        L.latLng(parseFloat(deliveryLat), parseFloat(deliveryLon))
                    ],
                    routeWhileDragging: true
                }).addTo(map);
                showModal("Route Started", "A route has been initiated on the map. Please follow the instructions.");
            }
        }

        async function acceptBooking(bookingId) {
            if (!CURRENT_DRIVER_ID) {
                showModal("Error", "Driver ID not available. Please try logging in again.");
                return;
            }
            try {
                const bookingRef = doc(db, `artifacts/${appId}/public/data/bookings`, bookingId);
                await updateDoc(bookingRef, {
                    status: "Confirmed",
                    driverId: CURRENT_DRIVER_ID,
                    assignedAt: serverTimestamp()
                });
                showModal("Booking Accepted", `Booking #${bookingId} has been successfully assigned to you.`);
            } catch (error) {
                console.error("Error accepting booking:", error.message);
                showModal("Error", `Failed to accept booking: ${error.message}`);
            }
        }

        async function updateStatus(bookingId, newStatus) {
            try {
                const bookingRef = doc(db, `artifacts/${appId}/public/data/bookings`, bookingId);
                const updateData = { status: newStatus };

                if (newStatus === 'Completed') {
                    updateData.completionDate = serverTimestamp();
                }

                await updateDoc(bookingRef, updateData);
                showModal("Success", `Booking status updated to ${newStatus}.`);

            } catch (error) {
                console.error("Error updating booking status:", error);
                showModal("Error", `Failed to update status to ${newStatus}: ${error.message}`);
            }
        }
        
        async function startLocationTracking() {
            if (!CURRENT_DRIVER_ID) return;
            const startBtn = document.getElementById('start-tracking-btn');
            const stopBtn = document.getElementById('stop-tracking-btn');

            startBtn.disabled = true;
            stopBtn.disabled = false;

            showModal("Location Tracking", "Location tracking has started.");

            locationTrackingInterval = setInterval(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const driverRef = doc(db, `artifacts/${appId}/public/data/drivers`, CURRENT_DRIVER_ID);
                            await updateDoc(driverRef, {
                                location: { latitude, longitude }
                            });
                        } catch (error) {
                            console.error("Error updating driver location:", error);
                        }
                    }, (error) => {
                        console.error("Geolocation error:", error);
                    });
                } else {
                    showModal("Error", "Geolocation is not supported by this browser.");
                    stopLocationTracking();
                }
            }, 5000);
        }

        function stopLocationTracking() {
            if (locationTrackingInterval) {
                clearInterval(locationTrackingInterval);
                locationTrackingInterval = null;
                showModal("Location Tracking", "Location tracking has stopped.");
            }
            const startBtn = document.getElementById('start-tracking-btn');
            const stopBtn = document.getElementById('stop-tracking-btn');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        // --- Main Execution Block ---
        // Fix: Sign in with custom token happens before the auth state listener is set up
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Custom token sign-in failed:", error);
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    CURRENT_DRIVER_ID = user.uid;
                    // Fix: Removed redundant signInWithCustomToken call here

                    const userDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid));
                    if (userDoc.exists() && userDoc.data().isDriver) {
                        const { firstName, lastName } = userDoc.data();
                        const welcomeMessageElement = document.getElementById('welcome-message');
                        if (welcomeMessageElement) {
                            welcomeMessageElement.textContent = `Welcome back, ${firstName}. Here's what's happening with your deliveries today.`;
                        }

                        initDriverMap();
                        fetchAndDisplayBookings();
                        fetchDriverPerformance();
                        
                        document.getElementById('logout-btn').addEventListener('click', async () => {
                            await signOut(auth);
                            window.location.replace('/login.html');
                        });
                        
                        document.getElementById('availability-toggle-btn').addEventListener('click', toggleAvailability);
                        
                        const startTrackingBtn = document.getElementById('start-tracking-btn');
                        const stopTrackingBtn = document.getElementById('stop-tracking-btn');
                        const serviceRadiusSelect = document.getElementById('service-radius-select');

                        if (startTrackingBtn) startTrackingBtn.addEventListener('click', startLocationTracking);
                        if (stopTrackingBtn) stopTrackingBtn.disabled = true;
                        if (stopTrackingBtn) stopTrackingBtn.addEventListener('click', stopLocationTracking);
                        if (serviceRadiusSelect) serviceRadiusSelect.addEventListener('change', filterAndDisplayAvailableBookings);

                    } else {
                        showModal("Access Denied", "You are not authorized to view this page.");
                        await signOut(auth);
                        window.location.replace('/login.html');
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    showModal("Error", "Error loading user data. Please try again.");
                }
            } else {
                window.location.replace('/login.html');
            }
        });
    </script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</body>
</html>
