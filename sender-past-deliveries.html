<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Past Deliveries - Sender</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --primary-color: #2e7d32;
        --secondary-color: #4caf50;
        --background-color: #f0f2f5;
        --card-background: #ffffff;
        --text-color: #333333;
        --text-light: #555555;
        --border-color: #e0e0e0;
        --shadow-color: rgba(0, 0, 0, 0.1);
      }
      .dark-mode:root {
        --primary-color: #43a047;
        --secondary-color: #66bb6a;
        --background-color: #121212;
        --card-background: #1e1e1e;
        --text-color: #e0e0e0;
        --text-light: #a0a0a0;
        --border-color: #444444;
        --shadow-color: rgba(255, 255, 255, 0.1);
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background-color: var(--background-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
      }
      .top-navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background-color: var(--card-background);
        box-shadow: 0 2px 4px var(--shadow-color);
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      .top-navbar .logo {
        font-weight: bold;
        font-size: 1.5rem;
        color: var(--primary-color);
        text-decoration: none;
      }
      .top-navbar .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .top-navbar .user-info .user-avatar {
        width: 40px;
        height: 40px;
        background-color: var(--secondary-color);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        background-color: var(--card-background);
        box-shadow: 2px 0 5px var(--shadow-color);
        transition: left 0.3s;
        z-index: 1001;
        padding-top: 60px;
      }
      .sidebar.open {
        left: 0;
      }
      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .sidebar ul li a,
      .sidebar ul li button {
        display: block;
        padding: 1rem 1.5rem;
        color: var(--text-color);
        text-decoration: none;
        font-size: 1.1rem;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .sidebar ul li a:hover,
      .sidebar ul li button:hover {
        background-color: #e9e9e9;
      }
      .dark-mode .sidebar ul li a:hover,
      .dark-mode .sidebar ul li button:hover {
        background-color: #333;
      }
      .sidebar ul li a i,
      .sidebar ul li button i {
        margin-right: 1rem;
      }
      .main-content {
        padding: 2rem;
        transition: margin-left 0.3s;
      }
      .main-content h1 {
        color: var(--primary-color);
        font-size: 2rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
      }
      .deliveries-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
      .delivery-card {
        background-color: var(--card-background);
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px var(--shadow-color);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--border-color);
      }
      .delivery-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px var(--shadow-color);
      }
      .delivery-card h3 {
        margin-top: 0;
        color: var(--secondary-color);
        border-bottom: 1px dashed var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      .delivery-card p {
        margin: 0.5rem 0;
        color: var(--text-light);
      }
      .delivery-card .status {
        font-weight: bold;
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        color: white;
        text-transform: capitalize;
      }
      .delivery-card .status.pending {
        background-color: #ff9800; /* Amber */
      }
      .delivery-card .status.on-route {
        background-color: #2196f3; /* Blue */
      }
      .delivery-card .status.delivered {
        background-color: #4caf50; /* Green */
      }
      .alert {
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-weight: bold;
        display: none;
      }
      .alert.info {
        background-color: #e3f2fd;
        color: #1565c0;
      }
      .alert.warning {
        background-color: #fff3e0;
        color: #e65100;
      }
      .alert.error {
        background-color: #ffebee;
        color: #c62828;
      }
      @media (min-width: 768px) {
        .sidebar {
          left: 0;
        }
        .main-content {
          margin-left: 250px;
        }
        .top-navbar .menu-toggle {
          display: none;
        }
      }
      .menu-toggle {
        font-size: 1.5rem;
        cursor: pointer;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }
      .overlay.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="top-navbar">
      <div class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
      </div>
      <a href="#" class="logo">fikaConnect</a>
      <div class="user-info">
        <span id="userNameDisplay">Sender</span>
        <div class="user-avatar" id="userAvatar">S</div>
      </div>
    </div>

    <div class="sidebar" id="sidebar">
      <ul>
        <li>
          <a href="sender-dashboard.html"
            ><i class="fas fa-tachometer-alt"></i> Dashboard</a
          >
        </li>
        <li>
          <a href="sender-active-deliveries.html"
            ><i class="fas fa-truck-fast"></i> Active Deliveries</a
          >
        </li>
        <li>
          <a href="book-new-delivery.html"
            ><i class="fas fa-plus-circle"></i> Book New Delivery</a
          >
        </li>
        <li>
          <a href="sender-past-deliveries.html"
            ><i class="fas fa-history"></i> Past Deliveries</a
          >
        </li>
        <li>
          <a href="sender-profile.html"
            ><i class="fas fa-user-circle"></i> Profile</a
          >
        </li>
        <li>
          <a href="#" id="logoutBtnSidebar"
            ><i class="fas fa-sign-out-alt"></i> Logout</a
          >
        </li>
        <li style="position: absolute; bottom: 20px; width: 100%">
          <button id="themeToggle">
            <i class="fas fa-moon"></i> Dark Mode
          </button>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <h1>Past Deliveries</h1>
      <div id="deliveriesMessage" class="alert"></div>
      <div id="deliveriesList" class="deliveries-grid">
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      // --- Firebase Configuration ---
      const firebaseConfig = {
          apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
          authDomain: "fika-connect-5f844.firebaseapp.com",
          projectId: "fika-connect-5f844",
          storageBucket: "fika-connect-5f844.appspot.com",
          messagingSenderId: "492360448361",
          appId: "1:492360448361:web:4ab28b2b9828371d4b2f4a"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let CURRENT_SENDER_ID = null;

      // --- UI Element References ---
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const themeToggle = document.getElementById('themeToggle');
      const body = document.body;
      const logoutBtnSidebar = document.getElementById('logoutBtnSidebar');
      const userAvatar = document.getElementById('userAvatar');
      const userNameDisplay = document.getElementById('userNameDisplay');
      const deliveriesList = document.getElementById('deliveriesList');
      const deliveriesMessage = document.getElementById('deliveriesMessage');

      // --- UI Event Listeners ---
      menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('open');
          overlay.classList.toggle('active');
      });

      overlay.addEventListener('click', () => {
          sidebar.classList.remove('open');
          overlay.classList.remove('active');
      });

      themeToggle.addEventListener('click', () => {
          body.classList.toggle('dark-mode');
          const icon = themeToggle.querySelector('i');
          icon.classList.toggle('fa-moon');
          icon.classList.toggle('fa-sun');
      });

      // --- Firebase Auth & Firestore Logic ---
      onAuthStateChanged(auth, (user) => {
          if (user) {
              CURRENT_SENDER_ID = user.uid;
              userNameDisplay.textContent = user.displayName || 'Sender';
              userAvatar.textContent = (user.displayName || 'S').charAt(0).toUpperCase();
              fetchPastDeliveries();
          } else {
              window.location.href = 'login.html';
          }
      });

      logoutBtnSidebar.addEventListener('click', (e) => {
          e.preventDefault();
          signOut(auth).then(() => {
              window.location.href = 'login.html';
          }).catch((error) => {
              console.error("Logout Error:", error);
          });
      });

      async function fetchPastDeliveries() {
          if (!CURRENT_SENDER_ID) {
              showMessage("You must be logged in to view deliveries.", 'error');
              return;
          }

          deliveriesMessage.textContent = "Loading your past deliveries...";
          deliveriesMessage.className = 'alert info';
          deliveriesMessage.style.display = 'block';
          deliveriesList.innerHTML = '';

          try {
              const q = query(
                  collection(db, "deliveries"),
                  where("senderId", "==", CURRENT_SENDER_ID),
                  where("status", "==", "delivered"),
                  orderBy("timestamp", "desc")
              );
              const querySnapshot = await getDocs(q);

              if (querySnapshot.empty) {
                  deliveriesMessage.textContent = "You have no past deliveries.";
                  deliveriesMessage.className = 'alert warning';
              } else {
                  deliveriesMessage.style.display = 'none';
                  querySnapshot.forEach((doc) => {
                      const delivery = doc.data();
                      const deliveryCard = createDeliveryCard(doc.id, delivery);
                      deliveriesList.appendChild(deliveryCard);
                  });
              }
          } catch (e) {
              console.error("Error fetching deliveries: ", e);
              showMessage("An error occurred while fetching deliveries. Please try again.", 'error');
          }
      }

      function createDeliveryCard(docId, delivery) {
          const deliveryCard = document.createElement('div');
          deliveryCard.className = 'delivery-card';
          
          const pickupInfo = delivery.deliveryType === 'direct' ? `Lat: ${delivery.pickup.lat}, Lng: ${delivery.pickup.lng}` : delivery.pickup.name;
          const dropoffInfo = delivery.deliveryType === 'direct' ? `Lat: ${delivery.dropoff.lat}, Lng: ${delivery.dropoff.lng}` : delivery.dropoff.name;
          
          deliveryCard.innerHTML = `
              <h3>Booking ID: ${docId}</h3>
              <p><strong>Pickup:</strong> ${pickupInfo}</p>
              <p><strong>Drop-off:</strong> ${dropoffInfo}</p>
              <p><strong>Status:</strong> <span class="status ${delivery.status}">${delivery.status}</span></p>
              <p><strong>Description:</strong> ${delivery.package.description}</p>
              <p><strong>Total Fare:</strong> UGX ${delivery.fareDetails.totalFare.toLocaleString()}</p>
              <p><strong>Type:</strong> ${delivery.deliveryType === 'direct' ? 'Direct Delivery' : 'Collection Point'}</p>
          `;
          return deliveryCard;
      }

      function showMessage(message, type) {
          deliveriesMessage.textContent = message;
          deliveriesMessage.className = `alert ${type}`;
          deliveriesMessage.style.display = 'block';
          setTimeout(() => {
              deliveriesMessage.style.display = 'none';
          }, 5000);
      }
    </script>
  </body>
</html>