<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Book New Delivery | FikaConnect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
</head>
<style>
    /* ... (Your existing CSS code is here) ... */

    :root {
        --bg-light: #f8f9fa;
        --bg-dark: #121212;
        --text-light: #fff;
        --text-dark: #222;
        --primary: #28a745;
        --primary-dark: #1e7e34;
        --secondary: #6c757d;
        --card-light: #ffffff;
        --card-dark: #1e1e1e;
        --status-pending: #ffc107;
        --status-picked-up: #17a2b8;
        --status-in-transit: #007bff;
        --status-delivered: #28a745;
        --status-cancelled: #dc3545;
        --sidebar-width: 260px;
        --header-height: 70px;
        --transition: all 0.3s ease;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --border-radius: 12px;
    }

    body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        background-color: #f0f2f5;
        color: var(--text-dark);
        transition: var(--transition);
        display: flex;
        min-height: 100vh;
    }

    body.dark-mode {
        background-color: var(--bg-dark);
        color: var(--text-light);
    }

    /* Top Bar & Header */
    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: var(--card-light);
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        padding: 0 20px;
        z-index: 1000;
        transition: var(--transition);
    }

    .dark-mode .top-bar {
        background: var(--card-dark);
    }

    .menu-toggle {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: var(--primary);
        cursor: pointer;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        transition: var(--transition);
        z-index: 1001;
    }

    .menu-toggle:hover {
        background: rgba(40, 167, 69, 0.1);
    }

    .logo {
        display: flex;
        align-items: center;
        font-weight: 700;
        font-size: 1.4rem;
        color: var(--primary);
        text-decoration: none;
    }

    #map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-top: 20px;
    }

    .logo i {
        margin-right: 10px;
        font-size: 1.6rem;
    }

    .user-actions {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .theme-toggle {
        background: transparent;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        color: var(--primary);
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .theme-toggle:hover {
        background: rgba(40, 167, 69, 0.1);
    }

    .language-selector {
        position: relative;
    }

    .language-selector select {
        background: rgba(40, 167, 69, 0.1);
        border: 1px solid rgba(40, 167, 69, 0.2);
        color: var(--primary);
        padding: 8px 15px;
        border-radius: 30px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        transition: var(--transition);
        min-width: 120px;
    }

    .language-selector select:hover {
        background: rgba(40, 167, 69, 0.2);
    }

    .dark-mode .language-selector select {
        background: rgba(40, 167, 69, 0.2);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        border-radius: 30px;
        background: rgba(40, 167, 69, 0.1);
        cursor: pointer;
        transition: var(--transition);
    }

    .user-profile:hover {
        background: rgba(40, 167, 69, 0.2);
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .user-name {
        font-weight: 600;
        font-size: 0.95rem;
    }

    /* Sidebar */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 70px;
        height: 100vh;
        background-color: var(--card-light);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        transition: width 0.3s ease;
        z-index: 990;
        overflow-x: hidden;
    }

    .dark-mode .sidebar {
        background-color: var(--card-dark);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar:hover {
        width: var(--sidebar-width);
    }

    .sidebar-header {
        display: none;
    }

    .sidebar:hover .sidebar-header {
        display: block;
        padding: 20px 20px 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
    }

    .sidebar:hover .sidebar-header h2 {
        color: var(--primary);
        margin-bottom: 5px;
        font-size: 1.4rem;
    }

    .sidebar:hover .sidebar-header p {
        font-size: 0.85rem;
        color: var(--secondary);
        margin: 0;
    }

    .sidebar-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        padding-top: 80px;
        /* Space for the top bar */
    }

    .sidebar:hover .sidebar-nav ul {
        padding-top: 0;
    }

    .sidebar-nav a {
        text-decoration: none;
        color: inherit;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 12px 0;
        transition: var(--transition);
        position: relative;
        white-space: nowrap;
    }

    .sidebar:hover .sidebar-nav a {
        justify-content: flex-start;
        padding: 12px 20px;
    }

    .sidebar-nav a:hover,
    .sidebar-nav a.active {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--primary);
    }

    .sidebar-nav a.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--primary);
        border-radius: 0 4px 4px 0;
    }

    .sidebar-nav a i {
        min-width: 24px;
        text-align: center;
        font-size: 1.1rem;
    }

    .sidebar-nav a span {
        display: none;
    }

    .sidebar:hover .sidebar-nav a span {
        display: inline;
    }

    .sidebar-footer {
        margin-top: auto;
        padding: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: none;
    }

    .sidebar:hover .sidebar-footer {
        display: block;
    }

    .dark-mode .sidebar-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .logout-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 12px 15px;
        background-color: #dc3545;
        color: #fff;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-size: 1rem;
    }

    .logout-btn:hover {
        background-color: #c82333;
        transform: translateY(-2px);
    }

    /* Main Content */
    .main-content {
        flex: 1;
        margin-left: 70px;
        padding-top: calc(var(--header-height) + 20px);
        padding-bottom: 20px;
        padding-left: 20px;
        padding-right: 20px;
        transition: margin-left 0.3s;
    }

    .sidebar:hover+.main-content {
        margin-left: var(--sidebar-width);
    }

    /* Page specific styles */
    .page-header {
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .page-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
    }

    .page-header h2 i {
        color: var(--primary);
    }

    /* Form Styling */
    .booking-form-container {
        background-color: var(--card-light);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(0, 0, 0, 0.03);
        max-width: 800px;
        margin: 0 auto;
    }

    .dark-mode .booking-form-container {
        background-color: var(--card-dark);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .booking-form h3 {
        font-size: 1.5rem;
        margin-bottom: 25px;
        color: var(--primary);
        text-align: center;
    }

    .form-section {
        margin-bottom: 25px;
        padding: 20px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        background-color: var(--bg-light);
    }

    .dark-mode .form-section {
        border: 1px solid rgba(255, 255, 255, 0.05);
        background-color: var(--bg-dark);
    }

    .form-section h4 {
        font-size: 1.2rem;
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .dark-mode .form-section h4 {
        color: var(--text-light);
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .dark-mode .form-group label {
        color: var(--text-light);
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="tel"],
    .form-group textarea,
    .form-group select {
        width: calc(100% - 24px);
        /* Account for padding */
        padding: 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        font-size: 1rem;
        background-color: var(--bg-light);
        color: var(--text-dark);
        transition: border-color 0.3s ease;
    }

    .dark-mode .form-group input[type="text"],
    .dark-mode .form-group input[type="number"],
    .dark-mode .form-group input[type="tel"],
    .dark-mode .form-group textarea,
    .dark-mode .form-group select {
        border: 1px solid rgba(255, 255, 255, 0.1);
        background-color: var(--card-dark);
        color: var(--text-light);
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .note {
        font-size: 0.9rem;
        color: var(--secondary);
        margin-top: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 8px;
    }

    .dark-mode .note {
        background: rgba(255, 255, 255, 0.05);
        color: #aaa;
    }

    .checkbox-group {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
        margin-top: 4px;
    }

    .checkbox-group label {
        display: inline;
        margin-bottom: 0;
        font-weight: 400;
    }
    
    .validation-message {
        color: var(--status-cancelled);
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
    }

    .location-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .location-input-group input {
        flex-grow: 1;
    }

    .select-on-map-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
        white-space: nowrap;
    }

    .select-on-map-btn:hover {
        background-color: var(--primary-dark);
    }

    #map {
        height: 300px;
        width: 100%;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .dark-mode #map {
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }

    .submit-btn,
    .cancel-form-btn {
        padding: 12px 30px;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
    }

    .submit-btn:hover {
        background: linear-gradient(90deg, var(--primary), #20c997);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .cancel-form-btn {
        background-color: var(--secondary);
        color: #fff;
    }

    .cancel-form-btn:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
    }

    /* Messages */
    #bookingMessage {
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
        display: none;
        /* Hidden by default */
    }

    #bookingMessage.success {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--primary);
    }

    #bookingMessage.error {
        background-color: rgba(220, 53, 69, 0.1);
        color: var(--status-cancelled);
    }

    #bookingMessage.info {
        background-color: rgba(0, 123, 255, 0.1);
        color: #007bff;
    }
    
    #mapSelectionInfo {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 999;
        text-align: center;
        display: none;
    }


    /* Delivery Type Selection */
    .delivery-type-selection {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .delivery-type-selection label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--secondary);
        transition: all 0.3s ease;
    }

    .delivery-type-selection input[type="radio"] {
        display: none;
    }

    .delivery-type-selection input[type="radio"]:checked+label {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
    }

    .delivery-type-selection label:hover {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--primary);
        border-color: var(--primary);
    }

    .dark-mode .delivery-type-selection label:hover {
        background-color: rgba(40, 167, 69, 0.2);
        color: white;
    }

    .dark-mode .delivery-type-selection input[type="radio"]:checked+label {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Collection Points Section */
    #collectionPointsSection {
        display: none;
        /* Hidden by default */
    }

    #collectionPointsSection .form-group select {
        width: 100%;
    }


    /* Footer */
    .page-footer {
        text-align: center;
        padding: 25px 0;
        font-size: 0.95rem;
        color: var(--secondary);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        margin-top: auto;
    }

    .dark-mode .page-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        color: #aaa;
    }

    /* Overlay for mobile */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 800;
    }

    .overlay.active {
        display: block;
    }

    /* Responsive Improvements */
    @media (max-width: 991px) {
        .sidebar {
            width: var(--sidebar-width);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            top: 0;
            height: 100%;
            box-shadow: var(--shadow);
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar:hover {
            width: var(--sidebar-width);
            /* Override hover for mobile */
        }
        .sidebar-nav ul {
            padding-top: 80px;
            /* Adjust padding for mobile sidebar */
        }
        .sidebar-header {
            display: block;
            padding: 20px;
        }
        .sidebar-nav a {
            justify-content: flex-start;
            padding: 12px 20px;
        }
        .sidebar-nav a span {
            display: inline;
        }
        .main-content {
            margin-left: 0;
            padding-left: 15px;
            padding-right: 15px;
            padding-top: calc(var(--header-height) + 15px);
        }
        .booking-form-container {
            padding: 20px;
        }
        .form-actions {
            flex-direction: column;
            gap: 15px;
        }
        .submit-btn,
        .cancel-form-btn {
            width: 100%;
        }
        .delivery-type-selection {
            flex-direction: column;
        }
    }
    @media (min-width: 992px) {
        .menu-toggle {
            display: none;
        }
        .overlay {
            display: none !important;
        }
        .sidebar-nav ul {
            padding-top: 80px;
            /* Space for top bar */
        }
        .sidebar:hover .sidebar-nav ul {
            padding-top: 0;
        }
        .sidebar-footer {
            display: block;
        }
        .sidebar:not(:hover) .sidebar-footer {
            display: none;
        }
    }
    @media (max-width: 768px) {
        .page-header h2 {
            font-size: 1.5rem;
        }
        .user-name {
            display: none;
        }
        .user-profile {
            padding: 8px 12px;
        }
    }
    .results-container {
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        padding: 15px;
        margin-top: 25px;
        background-color: var(--bg-light);
        display: flex;
        justify-content: space-around;
        text-align: center;
    }
    .dark-mode .results-container {
        border: 1px solid rgba(255, 255, 255, 0.05);
        background-color: var(--bg-dark);
    }
    .result-item {
        flex-grow: 1;
        padding: 0 10px;
    }
    .result-item strong {
        display: block;
        font-size: 0.9rem;
        color: var(--secondary);
        margin-bottom: 5px;
    }
    .dark-mode .result-item strong {
        color: #aaa;
    }
    .result-item span {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }
</style>
<body>
    <div class="overlay" id="overlay"></div>

    <div class="top-bar">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <a href="index.html" class="logo">
            <i class="fas fa-shipping-fast"></i> FikaConnect
        </a>
        <div class="user-actions">
            <div class="language-selector">
                <select id="languageSelector">
                    <option value="en">English</option>
                    <option value="lg">Luganda</option>
                    <option value="sw">Kiswahili</option>
                    <option value="fr">French</option>
                </select>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">S</div>
                <span class="user-name" id="userNameDisplay">Sender</span>
            </div>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>FikaConnect</h2>
            <p data-translate="sidebarDashboardTitle">Sender Dashboard</p>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> <span data-translate="navDashboard">Dashboard</span></a></li>
                <li><a href="book-new-delivery.html" class="active"><i class="fas fa-plus-circle"></i> <span data-translate="navBookNew">Book New</span></a></li>
                <li><a href="sender profile.html"><i class="fas fa-user-circle"></i> <span data-translate="navProfile">My Profile</span></a></li>
                <li><a href="sender-active-deliveries.html"><i class="fas fa-history"></i> <span data-translate="navBookings">My Bookings</span></a></li>
                <li><a href="sender-settings.html"><i class="fas fa-cog"></i> <span data-translate="navSettings">Settings</span></a></li>
                <li><a href="contact-us.html"><i class="fas fa-headset"></i> <span data-translate="navContact">Contact Us</span></a></li>
                <li><a href="about.html"><i class="fas fa-info-circle"></i> <span data-translate="navAbout">About Us</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <a href="#" class="logout-btn" id="logoutBtnSidebar"><i class="fas fa-sign-out-alt"></i> <span data-translate="logout">Logout</span></a>
        </div>
    </aside>

    <div class="main-content">
        <div class="page-header">
            <h2 data-translate="bookNewDeliveryTitle"><i class="fas fa-plus-circle"></i> Book a New Delivery</h2>
        </div>

        <div class="booking-form-container">
            <form id="newBookingForm" class="booking-form">
                <div id="bookingMessage" class="alert alert-info" style="display: none;"></div>

                <div class="form-section">
                    <h4><i class="fas fa-user-circle"></i> Sender Details</h4>
                    <div class="form-group">
                        <label for="senderName">Sender Name:</label>
                        <input type="text" id="senderName" name="senderName" placeholder="e.g., John Doe" required>
                    </div>
                </div>

                <div class="form-section">
                    <h4 data-translate="locationDetailsTitle"><i class="fas fa-map-marker-alt"></i> Location Details</h4>
                    <div class="delivery-type-selection">
                        <input type="radio" id="directDelivery" name="deliveryType" value="direct" checked>
                        <label for="directDelivery" data-translate="directDeliveryLabel"><i class="fas fa-truck"></i> Direct Delivery</label>
                        <input type="radio" id="collectionPointDelivery" name="deliveryType" value="collection_point">
                        <label for="collectionPointDelivery" data-translate="collectionPointDeliveryLabel"><i class="fas fa-map-pin"></i> Collection Point</label>
                    </div>
                    
                    <div id="directDeliverySection">
                        <div class="checkbox-group">
                            <input type="checkbox" id="transportCostCheckbox" name="transportCostCheckbox" required>
                            <label for="transportCostCheckbox" data-translate="transportCostNote">
                                I understand that transport costs for the driver to my pickup point are my responsibility. The delivery price is counted from the pickup point to the drop-off point.
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="pickupAddress">Pickup Address:</label>
                            <input type="text" id="pickupAddress" name="pickupAddress" placeholder="Enter pickup address">
                            <div class="validation-message" id="pickupAddressValidation">Please select a pickup location.</div>
                        </div>

                        <div class="form-group">
                            <label for="dropoffAddress">Drop-off Address:</label>
                            <input type="text" id="dropoffAddress" name="dropoffAddress" placeholder="Enter drop-off address">
                            <div class="validation-message" id="dropoffAddressValidation">Please select a drop-off location.</div>
                        </div>

                        <div id="map" style="height: 400px; width: 100%;"></div>
                        <input type="hidden" id="pickupLat" name="pickupLat">
                        <input type="hidden" id="pickupLng" name="pickupLng">
                        <input type="hidden" id="dropoffLat" name="dropoffLat">
                        <input type="hidden" id="dropoffLng" name="dropoffLng">
                    </div>

                    <div id="collectionPointsSection">
                        <div class="form-group">
                            <label for="pickupPoint">Select Pickup Point:</label>
                            <select id="pickupPoint" name="pickupPoint"></select>
                        </div>
                        <div class="form-group">
                            <label for="dropoffPoint">Select Drop-off Point:</label>
                            <select id="dropoffPoint" name="dropoffPoint"></select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 data-translate="recipientDetailsTitle"><i class="fas fa-user"></i> Recipient Details</h4>
                    <div class="form-group">
                        <label for="recipientName" data-translate="recipientNameLabel">Recipient Name:</label>
                        <input type="text" id="recipientName" name="recipientName" placeholder="e.g., Jane Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="recipientNumber" data-translate="recipientNumberLabel">Recipient Number:</label>
                        <input type="tel" id="recipientNumber" name="recipientNumber" placeholder="e.g., +256771234567" required>
                    </div>
                </div>

                <div class="form-section">
                    <h4 data-translate="packageDetailsTitle"><i class="fas fa-box-open"></i> Package Details</h4>
                    <div class="form-group">
                        <label for="packageDescription" data-translate="packageDescriptionLabel">Package Description:</label>
                        <textarea id="packageDescription" name="packageDescription" placeholder="e.g., Clothes, documents, food" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="packageWeight" data-translate="packageWeightLabel">Package Weight (kg):</label>
                        <input type="number" id="packageWeight" name="packageWeight" placeholder="e.g., 2.5" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="packageDimensions" data-translate="packageDimensionsLabel">Package Dimensions (LxWxH in cm):</label>
                        <input type="text" id="packageDimensions" name="packageDimensions" placeholder="e.g., 30x20x10">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-form-btn" data-translate="cancelButton" onclick="window.location.href='sender-active-deliveries.html'">Cancel</button>
                    <button type="submit" class="submit-btn" data-translate="submitButton">Book Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
     const firebaseConfig = {
  apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
  authDomain: "fika-connect-5f844.firebaseapp.com",
  projectId: "fika-connect-5f844",
  storageBucket: "fika-connect-5f844.appspot.com",
  messagingSenderId: "492360448361",
  appId: "1:492360448361:web:4ab28b2b9828371d4b2f4a",
  databaseURL: "https://fika-connect-5f844-default-rtdb.firebaseio.com/"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const newBookingForm = document.getElementById('newBookingForm');
        const senderNameInput = document.getElementById('senderName');
        const pickupAddressInput = document.getElementById('pickupAddress');
        const dropoffAddressInput = document.getElementById('dropoffAddress');
        const pickupLatInput = document.getElementById('pickupLat');
        const pickupLngInput = document.getElementById('pickupLng');
        const dropoffLatInput = document.getElementById('dropoffLat');
        const dropoffLngInput = document.getElementById('dropoffLng');
        const bookingMessage = document.getElementById('bookingMessage');
        const directDeliverySection = document.getElementById('directDeliverySection');
        const collectionPointsSection = document.getElementById('collectionPointsSection');
        const directDeliveryRadio = document.getElementById('directDelivery');
        const collectionPointDeliveryRadio = document.getElementById('collectionPointDelivery');

        // Geocoding and map setup
        let map;
        let pickupMarker, dropoffMarker;
        let pickupLocation = null;
        let dropoffLocation = null;

        // Geocoding function (address to coordinates) using Nominatim
        async function geocode(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data && data.length > 0) {
                return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            }
            return null;
        }

        // Reverse geocoding function (coordinates to address)
        async function reverseGeocode(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data && data.address) {
                return data.display_name;
            }
            return 'Address not found';
        }

        // Initialize the map
        function initMap() {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([0.31628, 32.58219], 13); // Centered on Kampala, Uganda

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add event listener for map clicks
            map.on('click', async function(e) {
                const { lat, lng } = e.latlng;

                // Check which location the user wants to set
                if (!pickupLocation) {
                    setPickupLocation(lat, lng);
                } else if (!dropoffLocation) {
                    setDropoffLocation(lat, lng);
                } else {
                    alert('Both locations are set. Click the map to update the last set location.');
                }
            });
        }

        // Set pickup location on map and form
        async function setPickupLocation(lat, lng) {
            pickupLocation = { lat, lng };
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
            }
            pickupMarker = L.marker([lat, lng]).addTo(map).bindPopup('Pickup Location').openPopup();
            map.setView([lat, lng], 13);

            const address = await reverseGeocode(lat, lng);
            pickupAddressInput.value = address;
            pickupLatInput.value = lat;
            pickupLngInput.value = lng;
        }

        // Set drop-off location on map and form
        async function setDropoffLocation(lat, lng) {
            dropoffLocation = { lat, lng };
            if (dropoffMarker) {
                map.removeLayer(dropoffMarker);
            }
            dropoffMarker = L.marker([lat, lng], { icon: L.icon({ iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-red.png', shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png', iconSize: [38, 95], shadowSize: [50, 64], iconAnchor: [22, 94], shadowAnchor: [4, 62], popupAnchor: [-3, -76] }) }).addTo(map).bindPopup('Drop-off Location').openPopup();
            
            dropoffAddressInput.value = await reverseGeocode(lat, lng);
            dropoffLatInput.value = lat;
            dropoffLngInput.value = lng;
        }

        // Handle address input changes
        pickupAddressInput.addEventListener('change', async (e) => {
            const address = e.target.value;
            const coords = await geocode(address);
            if (coords) {
                setPickupLocation(coords.lat, coords.lng);
            } else {
                alert('Address not found. Please try again or select on map.');
            }
        });

        dropoffAddressInput.addEventListener('change', async (e) => {
            const address = e.target.value;
            const coords = await geocode(address);
            if (coords) {
                setDropoffLocation(coords.lat, coords.lng);
            } else {
                alert('Address not found. Please try again or select on map.');
            }
        });

        // Toggle between direct and collection point delivery
        function toggleDeliveryType(type) {
            if (type === 'direct') {
                directDeliverySection.style.display = 'block';
                collectionPointsSection.style.display = 'none';
                initMap();
            } else {
                directDeliverySection.style.display = 'none';
                collectionPointsSection.style.display = 'block';
                if (map) {
                    map.remove();
                    map = null;
                }
            }
        }
        
        directDeliveryRadio.addEventListener('change', () => toggleDeliveryType('direct'));
        collectionPointDeliveryRadio.addEventListener('change', () => toggleDeliveryType('collection_point'));

        // Form submission handler
        newBookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get current user ID
            const user = auth.currentUser;
            if (!user) {
                bookingMessage.textContent = 'You must be logged in to book a delivery.';
                bookingMessage.className = 'alert alert-error';
                bookingMessage.style.display = 'block';
                return;
            }

            // Simple form validation
            if (!pickupLocation || !dropoffLocation) {
                bookingMessage.textContent = 'Please select both pickup and drop-off locations on the map.';
                bookingMessage.className = 'alert alert-error';
                bookingMessage.style.display = 'block';
                return;
            }

            // Build booking data object
            const bookingData = {
                senderId: user.uid,
                senderName: senderNameInput.value,
                recipientName: document.getElementById('recipientName').value,
                recipientNumber: document.getElementById('recipientNumber').value,
                package: {
                    description: document.getElementById('packageDescription').value,
                    weight: document.getElementById('packageWeight').value,
                    dimensions: document.getElementById('packageDimensions').value,
                },
                pickup: {
                    address: pickupAddressInput.value,
                    lat: pickupLocation.lat,
                    lng: pickupLocation.lng
                },
                dropoff: {
                    address: dropoffAddressInput.value,
                    lat: dropoffLocation.lat,
                    lng: dropoffLocation.lng
                },
                status: 'Pending Driver Assignment',
                bookingDate: new Date().toISOString()
            };

            try {
                // Add booking to Firestore
                const docRef = await db.collection('deliveries').add(bookingData);
                
                // Redirect on success
                window.location.href = `sender-active-deliveries.html?bookingId=${docRef.id}`;
            } catch (error) {
                console.error("Error adding document: ", error);
                bookingMessage.textContent = `Error booking delivery: ${error.message}`;
                bookingMessage.className = 'alert alert-error';
                bookingMessage.style.display = 'block';
            }
        });

        // Authentication guard and sender name pre-fill
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                senderNameInput.value = user.displayName || user.email;
                if (user.displayName) {
                    senderNameInput.readOnly = true;
                }
                initMap();
                toggleDeliveryType('direct');
            } else {
                // User is signed out. Redirect to login.
                window.location.href = `login.html?returnTo=${encodeURIComponent(window.location.href)}`;
            }
        });
    </script>
</body>
</html>